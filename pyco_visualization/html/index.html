<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>

	<script type="text/javascript" src="vue.js"></script>
	<script type="text/javascript" src="jquery-3.3.1.js"></script>
	<script src="lodash.js"></script>

	<link rel="stylesheet" href="styles.css">
</head>
<body>
<div id="top">
		<div>step: {{ view.step_id }}</div>
		<coro_state :coro_state="view.root"></coro_state>
</div>
<script type="text/javascript">
	Vue.component('coro_state', {
		props: ["coro_state"],
		template: `
			<div class="coro_state">
			{{ coro_state.status }} - {{ coro_state.comment }}
			<ul>
			<div v-for="child in coro_state.children" :key="child.id">
				<li>
				<coro_state :coro_state="child"></coro_state>
				</li>
			</div>
			</ul>
			</div>
		`
	});
	var vm = new Vue({
		el: '#top',
		data: {
			view: 
			{
				root:{status:"hello! loading trace file failed?"},
				step_id: -1,
				index: [],
			},
			snapshots: [],
			steps: [],
		},
		mounted: function ()
		{
			window.addEventListener('keydown', function (event) {
				c = event.keyCode;
				if (c==188 && vm.view.step_id > 0)
				{
					prev_step();
				}
				if (c==190 && vm.steps.length > 0)
					go_to_next_step();
			});
		}
	});

	const snapshot_interval = 80;
	function maybe_take_snapshot()
	{
		const step_id = vm.view.step_id;
		if (step_id % snapshot_interval == 0)
			if (vm.snapshots[step_id] === undefined)
				vm.snapshots[step_id] = _.cloneDeep(vm.view);
	}
	function go_to_next_step()
	{
		console.log("go_to_next_step");
		maybe_take_snapshot();
		move_view_to_next_step(vm.view)
	}
	function move_view_to_next_step(view)
	{
		const step = vm.steps[view.step_id+1];
		if (step != undefined)
		{
			view.step_id++
			step.forEach(op => {do_op(op, view)})
			return true;
		}
		else
			alert("undefined step:" + view.step_id)
		return false;
	}
	function prev_step()
	{
		console.log('prev_step')
		const wanted = vm.view.step_id - 1;
		let best = 0; // we never delete the 0 snapshot
		for (let idx = 0; idx < vm.snapshots.length; idx++)
		{
			if (idx > wanted)
				break;
			let snapshot = vm.snapshots[idx]
			if (snapshot != undefined)
				best = idx
		}
		//now best is the index of the closest snapshot
		let snapshot = _.cloneDeep(vm.snapshots[best])
		while (wanted > snapshot.step_id)
		{
			if (!move_view_to_next_step(snapshot))
			{
				alert("fail");
				return;
			}
		}
		vm.view.index = snapshot.index;
		vm.view.root = snapshot.root
		vm.view.step_id = wanted
	}
	function do_op(op, view)
	{
		let action = op.a;
		//console.log(op);

		/*if (action == "add")
		{
		}*/
		if (action == "set_comment")
		{
			if (view.index[op.id] == undefined)
				alert("comment before status for id "+op.id);
			view.index[op.id].comment = op.comment;
		}
		else if (action == "set_status")
		{
			//console.log(op.id + " status "  +  coro_status[op.status]);
			if (view.index[op.id] == undefined)
			{
				if (op.parent_id == undefined)
					alert("first status but no parent id?");
				add_state(op, view);
			}
			if (op.comment != undefined)
				view.index[op.id].comment = op.comment;
			view.index[op.id].status = coro_status[op.status];
			if (op.status === 0)
			{
				/*when a state is inactivated, its children
				will never be used again*/
				view.index[op.id].children.forEach(child => 
					remove_state(child.id, view));
				view.index[op.id].children = []
			}
		}
		/*else if (action == "remove")
		{
			_.pull(view.index[op.id].parent.children, view.index[op.id])
			view.index.splice(op.id, 1);
		}*/
		else 
			alert("unknown action:"+action)
	}
	function add_state(op, view)
	{
		state = {"children":[],"status":"idk"};
		state.id = op["id"];
		const parent_id = op["parent_id"];
		state.parent_id = parent_id;
		if (view.index.hasOwnProperty(parent_id))
		{
			state.parent = view.index[parent_id]
			view.index[parent_id].children.push(state)
		}
		else
		{
			view.root = state;
		}
		view.index[state.id] = state;
	}
	function remove_state(id, view)
	{
		//_.pull(view.index[id].parent.children, view.index[id])
		view.index.splice(id, 1);
	}

	const coro_status = ["INACTIVE", "ACTIVE", "EP", "YIELD", "BNODE_YIELD"]
	
$( document ).ready(function() {
console.log( "ready!" );
$.getScript( "../trace0.js", function( data, textStatus, jqxhr ) {
 // console.log( data ); // Data returned
  console.log( textStatus ); // Success
  console.log( jqxhr.status ); // 200
  console.log( "Load was performed." );
  go_to_next_step();
});    
});


	function S(x)
	{
		vm.steps.push(x);
	}


</script>
</body>
</html>
