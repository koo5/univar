<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<script type="text/javascript" src="vue.js"></script>
	<script type="text/javascript" src="jquery-3.3.1.js"></script>
	<link rel="stylesheet" href="styles.css">
</head>
<body>
<div id="top">
	<div id="step_id">
		step: <span v-html="step_id"></span>
	</div>
	<div id="trace_root">
		<state :state="root.trace"></state>
	</div>
	<br><br><br><br><br><br><br><br><br><br><br><br><br>
</div>
<script type="text/javascript">
	Vue.component('state', {
		props: ["state"],
		template: `
			<div class="state">
			{{ state.status }} - {{ state.comment }}
			<ul>
			<div v-for="child in state.children" :key="child.id">
				<li>
				<state :state="child"></state>
				</li>
			</div>
			</ul>
			</div>
			`});

	var vm = new Vue({
		el: '#top',
		data: {
			root : {"trace": {"banana":"pie"}},
			step_id: -1,
			file_offset: 0,
			steps: [],
			states: [],
		},
		mounted: function ()
		{
			this.$nextTick(function () {
			window.addEventListener('keydown', function (event) {
				c = event.keyCode;
				if (c==188 && vm.step_id > 0)
				{
					vm.step_id--;
				}
				if (c==190 && vm.steps.length > 0)
					next_step();
			});
			});
		}
	});

	function next_step()
	{
		console.log("next_step");
		vm.step_id++;
		let step_idx = vm.step_id - vm.file_offset;
		let step = vm.steps[vm.step_id - vm.file_offset];
		step.forEach(op => {do_op(op);});
	}

	function do_op(op)
	{
		let action = op.a;
		//console.log(op);

		if (action == "add")
		{
			state = {"children":[],"status":"idk"};
			state.id = op["id"];
			const parent_id = op["parent_id"];
			state.parent_id = parent_id;
			if (vm.states.hasOwnProperty(parent_id))
			{
				state.parent = vm.states[parent_id]
				vm.states[parent_id].children.push(state)
			}
			else
			{
				vm.root.trace = state;
			}
			vm.states[state.id] = state;

		}
		if (action == "set_comment")
		{
			vm.states[op.id].comment = op.comment;
		}
		if (action == "set_status")
		{
			console.log(op.id + " status "  +  coro_status[op.status]);	
			vm.states[op.id].status = coro_status[op.status];
		}
		if (action == "remove")
		{
			let ch = vm.states[op.id].parent.children;
			ch.splice(ch.indexOf(vm.states[op.id]), 1);
			vm.states.splice(vm.states.indexOf(op.id), 1);
		}
	}
	const coro_status = ["INACTIVE", "ACTIVE", "EP", "YIELD", "BNODE_YIELD"]
	
$( document ).ready(function() {
console.log( "ready!" );
$.getScript( "../trace0.js", function( data, textStatus, jqxhr ) {
 // console.log( data ); // Data returned
  console.log( textStatus ); // Success
  console.log( jqxhr.status ); // 200
  console.log( "Load was performed." );
  next_step();
});    
});


	function S(x)
	{
		vm.steps.push(x);
	}


</script>
</body>
</html>
